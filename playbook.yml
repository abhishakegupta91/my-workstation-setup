- name: Configure My Ubuntu/Debian Workstation
  hosts: localhost
  connection: local
  become: yes
  
  vars:
    # Get the username of the user running the playbook
    username: "{{ ansible_user_id }}"
  
  environment:
    LC_ALL: en_US.UTF-8
    LANG: en_US.UTF-8
    LANGUAGE: en_US.UTF-8

  tasks:
    - name: 1. Ensure UTF-8 locale is configured
      ansible.builtin.locale_gen:
        name: en_US.UTF-8
        state: present

    - name: 2. Set system locale to UTF-8
      ansible.builtin.command:
        cmd: localectl set-locale LANG=en_US.UTF-8
      changed_when: false

    - name: 3. Update APT Package Cache
      ansible.builtin.apt:
        update_cache: yes
      changed_when: false # Don't report this as a "change"

    - name: 4. Install Prerequisite Packages
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - git
          - ca-certificates
          - gnupg
          - build-essential
          - vim
        state: present

    - name: 5. Install Core CLI Tools
      ansible.builtin.apt:
        name:
          - zsh
          - htop
          - tmux
          - micro
        state: present

    # --- Oh My Zsh Installation (Native) ---
    - name: 6. Install Oh My Zsh
      become: no
      ansible.builtin.shell:
        cmd: |
          if [ ! -d "$HOME/.oh-my-zsh" ]; then
            RUNZSH=no sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
          fi
        creates: "/home/{{ username }}/.oh-my-zsh"

    - name: 4.2. Install Oh My Zsh plugins
      become: no
      ansible.builtin.shell:
        cmd: |
          # Install zsh-autosuggestions
          if [ ! -d "$HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions" ]; then
            git clone https://github.com/zsh-users/zsh-autosuggestions "$HOME/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
          fi
          
          # Install zsh-syntax-highlighting
          if [ ! -d "$HOME/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting" ]; then
            git clone https://github.com/zsh-users/zsh-syntax-highlighting "$HOME/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
          fi
          
          # Install you-should-use
          if [ ! -d "$HOME/.oh-my-zsh/custom/plugins/you-should-use" ]; then
            git clone https://github.com/MichaelAquilina/zsh-you-should-use "$HOME/.oh-my-zsh/custom/plugins/you-should-use"
          fi

    - name: 4.3. Change default shell to Zsh
      ansible.builtin.user:
        name: "{{ username }}"
        shell: /usr/bin/zsh

    # --- Docker Installation (Official Repo) ---
    - name: 5.1. Create directory for Docker GPG key
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      ignore_errors: yes

    - name: 5.2. Add Docker's official GPG key
      ansible.builtin.get_url:
        url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'
        force: true
      ignore_errors: yes

    - name: 5.3. Add Docker repository
      ansible.builtin.apt_repository:
        repo: >
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] 
          https://download.docker.com/linux/{{ ansible_distribution | lower }}
          {{ ansible_distribution_release }} stable
        state: present
        filename: docker
        update_cache: yes
      ignore_errors: yes

    - name: 5.4. Install Docker Engine (latest version)
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes
      ignore_errors: yes

    - name: 5.5. Add current user to 'docker' group
      ansible.builtin.user:
        name: "{{ username }}"
        groups: docker
        append: yes
      ignore_errors: yes
      when: "'docker-ce' in ansible_facts.packages"

    # --- Dotfile Configuration ---
    - name: 6. Copy dotfiles from repo to home directory
      become: no # Run this as the user
      ansible.builtin.copy:
        src: "dotfiles/{{ item }}"
        dest: "/home/{{ username }}/{{ item }}"
        mode: '0644'
        backup: yes # Creates a backup of existing files
      loop:
        - .zshrc
        - .gitconfig
        - .tmux.conf

    - name: 7. Display setup completion message
      ansible.builtin.debug:
        msg: |
          ðŸŽ‰ Workstation Setup Complete!
          
          ðŸ“‹ Services Installed:
          â€¢ Zsh + Oh My Zsh with enhanced plugins
          â€¢ Core CLI tools (curl, wget, git, vim, htop, tmux, micro)
          â€¢ Build tools (build-essential)
          â€¢ Cross-platform dotfiles
          â€¢ Docker installation was attempted (may have failed)
          
          ðŸ”§ Next Steps:
          1. Open a new terminal to use Zsh
          2. Check if Docker is available with: docker --version
          3. If Docker failed, install manually: https://docs.docker.com/engine/install/ubuntu/
          4. Customize your dotfiles in ~/ if needed