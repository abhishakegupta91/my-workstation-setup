---
- name: Configure Ubuntu/Debian Home Server
  hosts: localhost
  connection: local
  become: yes
  
  vars:
    # Get the actual username of the user running the playbook (not root)
    username: "{{ ansible_env.SUDO_USER | default(ansible_user_id) }}"
    # Portainer admin password (change this!)
    portainer_password: "admin123"
  
  environment:
    LC_ALL: en_US.UTF-8
    LANG: en_US.UTF-8
    LANGUAGE: en_US.UTF-8

  tasks:
    - name: 1. Ensure UTF-8 locale is configured
      ansible.builtin.locale_gen:
        name: en_US.UTF-8
        state: present

    - name: 2. Set system locale to UTF-8
      ansible.builtin.command:
        cmd: localectl set-locale LANG=en_US.UTF-8
      changed_when: false

    - name: 3. Update APT Package Cache
      ansible.builtin.apt:
        update_cache: yes
      changed_when: false

    - name: 4. Install Basic Utilities
      ansible.builtin.apt:
        name:
          - curl
          - wget
          - dnsutils
          - net-tools
          - htop
          - iotop
          - nethogs
          - logrotate
          - supervisor
          - rsync
          - ufw
          - nmap
        state: present

    - name: 5. Install Node.js (via NodeSource repository)
      ansible.builtin.shell:
        cmd: |
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          apt-get install -y nodejs
        creates: /usr/bin/node

    - name: 6. Install Nginx Web Server
      ansible.builtin.apt:
        name: nginx
        state: present

    - name: 7. Configure UFW Firewall
      ansible.builtin.ufw:
        state: enabled
        policy: deny

    - name: 8. Allow essential UFW ports
      ansible.builtin.ufw:
        rule: allow
        port: "{{ item }}"
      loop:
        - "22"    # SSH
        - "80"    # HTTP
        - "443"   # HTTPS
        - "51820" # WireGuard (default)

    - name: 9. Install and Start Docker
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present
        update_cache: yes
      ignore_errors: yes

    - name: 10. Add user to docker group
      ansible.builtin.user:
        name: "{{ username }}"
        groups: docker
        append: yes
      ignore_errors: yes

    - name: 11. Create Docker directory for Portainer
      ansible.builtin.file:
        path: /opt/portainer
        state: directory
        mode: '0755'
      ignore_errors: yes

    - name: 12. Deploy Portainer Container
      ansible.builtin.docker_container:
        name: portainer
        image: portainer/portainer-ce:latest
        ports:
          - "9443:9443"
          - "8000:8000"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - /opt/portainer:/data
        restart_policy: unless-stopped
        state: started
      ignore_errors: yes

    - name: 13. Install WireGuard
      ansible.builtin.apt:
        name: wireguard
        state: present

    - name: 14. Enable and start essential services
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
      loop:
        - nginx
        - docker
        - ufw
        - supervisor

    - name: 15. Copy Nginx configuration files
      ansible.builtin.copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: '0644'
        backup: yes
      loop:
        - src: config/nginx-default.conf
          dest: /etc/nginx/sites-available/default
        - src: config/project-template.conf
          dest: /etc/nginx/sites-projects/project-template.conf

    - name: 16. Create project configuration directory
      ansible.builtin.file:
        path: /etc/nginx/sites-projects
        state: directory
        mode: '0755'

    - name: 17. Restart Nginx to apply configuration
      ansible.builtin.systemd:
        name: nginx
        state: restarted

    - name: 18. Copy scripts and documentation
      ansible.builtin.copy:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: "{{ item.mode }}"
      loop:
        - src: scripts/server-info.sh
          dest: "/home/{{ username }}/server-info.sh"
          mode: '0755'
        - src: docs/project-setup.md
          dest: "/home/{{ username }}/project-setup.md"
          mode: '0644'

    - name: 19. Display setup completion message
      ansible.builtin.debug:
        msg: |
          üéâ Home Server Setup Complete!
          
          üìã Services Installed:
          ‚Ä¢ Nginx (System) - Reverse proxy + static files (HTTP:80, HTTPS:443)
          ‚Ä¢ Docker with Portainer: Installation was attempted (may have failed)
          ‚Ä¢ Node.js & npm - JavaScript runtime
          ‚Ä¢ WireGuard VPN - Secure remote access (Port:51820)
          ‚Ä¢ UFW Firewall - Security protection
          ‚Ä¢ Monitoring tools - htop, iotop, nethogs
          
          üåê Hybrid Architecture:
          ‚Ä¢ System Nginx handles ports 80/443 and SSL
          ‚Ä¢ Docker containers run on internal ports (8080+) if Docker installed
          ‚Ä¢ Easy project setup with template in /etc/nginx/sites-projects/
          
          üîß Next Steps:
          1. Configure WireGuard: wg-quick up wg0
          2. Check Docker: docker --version
          3. If Docker works: Set up Portainer at https://your-ip:9443
          4. Deploy projects via Docker + Portainer (if available)
          5. Add Nginx reverse proxy configs for projects
          6. Check project guide: ~/project-setup.md
          7. Run './server-info.sh' for system status
          
          üìÅ File Locations:
          ‚Ä¢ Nginx configs: config/ directory in this repo
          ‚Ä¢ Scripts: scripts/ directory in this repo
          ‚Ä¢ Documentation: docs/ directory in this repo
          ‚Ä¢ Project template: /etc/nginx/sites-projects/project-template.conf
          ‚Ä¢ Static files: /var/www/html/
          
          ‚ö†Ô∏è  Remember to log out and back in for Docker group changes (if Docker installed)!
